# mujoco-wasm-forge

English | [中文说明](README.zh-CN.md)

mujoco-wasm-forge is a reproducible build harness that turns MuJoCo releases into WebAssembly bundles.  
It scans the upstream headers, derives the wrapper export set, compiles both WASM and native comparison binaries, runs smoke/regression checks, and publishes versioned artifacts with metadata. The GitHub Actions workflow mirrors this exact sequence.

- **Input**: MuJoCo tag (currently 3.2.5, 3.3.7, and 3.3.8-alpha)  
- **Output**: `dist/<version>/{mujoco.js, mujoco.wasm[, mujoco.wasm.map], version.json, sbom.spdx.json}`  
- **Toolchain**: emsdk 4.0.10 and Node 20 (parity with CI)  
- **Scope**: simulation core only (visualization/UI families are intentionally excluded)

Repository mirror: https://github.com/lshdlut/mujoco-wasm-forge

### Upstream WASM alpha

Google DeepMind has soft-launched official MuJoCo WebAssembly bindings (see [issue #2585 comment](https://github.com/google-deepmind/mujoco/issues/2585#issuecomment-3473495118) and [commit 40862617](https://github.com/google-deepmind/mujoco/commit/4086261714d7cfbc1745d4c6cb0aa2116df45312)). Their build relies on Embind and currently targets MuJoCo 3.3.8. We are evaluating the differences (API coverage, runtime footprint, tooling) and will publish follow-up notes; meanwhile this repository continues to provide the autogenerated `_mjwf_*` pipeline and multi-version builds.

## Export rules (ABI summary)

- Equality: **C = A ∩ B**  
  - A → public C declarations in `mujoco.h` (and `mjspec.h` when present)  
  - B → symbols implemented in `libmujoco.a` (enumerated via `llvm-nm`)
- Hard gate: `(A ∩ B) − C = 0`; exported names must begin with `mj_`, `mju_`, `mjs_`, or `mjd_`
- Special exclusions  
  1. Reject visualization/UI families (`mjv_`, `mjr_`, `mjui_`, `mjp_`, `mjc_`)  
  2. Variadic functions require a matching `*_v` implementation; otherwise they are tagged as `variadic_no_v`
- Full reports live under `dist/<ver>/abi/exports_report.md` (pass `EMIT_JSON=1` to generate JSON)

## Artifacts

Both CI and canonical local builds produce:

- `dist/<mjVer>/mujoco.wasm` — WebAssembly binary
- `dist/<mjVer>/mujoco.js` — ES module factory (`createMuJoCo`)
- `dist/<mjVer>/mujoco.wasm.map` — optional source map
- `dist/<mjVer>/version.json` — metadata (MuJoCo tag, emsdk, sizes, sha256, git sha)
- `dist/<mjVer>/sbom.spdx.json` — SPDX SBOM (lightweight)

## Quick start (Node ESM)

```ts
import createMuJoCo from './dist/3.2.5/mujoco.js';

const Module = await createMuJoCo({
  locateFile: (p) => (p.endsWith('.wasm') ? './dist/3.2.5/mujoco.wasm' : p),
});

// Minimal pendulum XML
const xml = `<?xml version="1.0"?>\n<mujoco model="pendulum">\n  <option timestep="0.002" gravity="0 0 -9.81"/>\n  <worldbody>\n    <body name="link" pos="0 0 0.1">\n      <joint name="hinge" type="hinge" axis="0 1 0" damping="0.01"/>\n      <geom type="capsule" fromto="0 0 0 0 0 0.2" size="0.02" density="1000"/>\n    </body>\n  </worldbody>\n</mujoco>`;

const parseXMLString = Module.cwrap('mjwf_mj_parseXMLString', 'number', ['string', 'number', 'number', 'number']);
const compile = Module.cwrap('mjwf_mj_compile', 'number', ['number', 'number']);
const deleteSpec = Module.cwrap('mjwf_mj_deleteSpec', null, ['number']);
const makeData = Module.cwrap('mjwf_mj_makeData', 'number', ['number']);
const resetData = Module.cwrap('mjwf_mj_resetData', null, ['number', 'number']);
const step = Module.cwrap('mjwf_mj_step', null, ['number', 'number']);
const deleteData = Module.cwrap('mjwf_mj_deleteData', null, ['number']);
const deleteModel = Module.cwrap('mjwf_mj_deleteModel', null, ['number']);

const stackTop = Module.stackSave();
const errBufSize = 1024;
const errBuf = Module.stackAlloc(errBufSize);
Module.HEAP8.fill(0, errBuf, errBuf + errBufSize);

const specPtr = parseXMLString(xml, 0, errBuf, errBufSize);
if (!specPtr) throw new Error(`parse failed: ${Module.UTF8ToString(errBuf)}`);

const modelPtr = compile(specPtr, 0);
if (!modelPtr) throw new Error('compile failed');
deleteSpec(specPtr);

const dataPtr = makeData(modelPtr);
if (!dataPtr) throw new Error('makeData failed');

resetData(modelPtr, dataPtr);
step(modelPtr, dataPtr);

deleteData(dataPtr);
deleteModel(modelPtr);
Module.stackRestore(stackTop);
```

## CI and reproducibility

Single workflow: `.github/workflows/forge.yml`

- Matrix covers MuJoCo 3.2.5 and 3.3.7
- Toolchain pinned to emsdk 3.1.55 + Node 20
- 3.3.7 performs a two-stage configure and forces qhull to static (Emscripten requirement)
- Quality gates: `[GATE:SYM]`, `[GATE:DTS]`, `[GATE:RUN]` (non-implemented gates are logged as skipped)
- Artifacts uploaded directly from `dist/<mjVer>/`

### ABI-driven pipeline (per build)

1. `node scripts/mujoco_abi/autogen_wrappers.mjs` → produce MJAPI declarations (A-set)  
2. `node scripts/mujoco_abi/nm_coverage.mjs build/<short>/lib/libmujoco.a` → collect implementation symbols (B-set)  
3. `node scripts/mujoco_abi/gen_exports_from_abi.mjs` → emit wrappers, exports list, TypeScript stubs, reports  
4. CMake consumes the generated list (`-sEXPORTED_FUNCTIONS=@exports_<ver>.lst`)  
5. `node scripts/mujoco_abi/check_exports.mjs ...` → ensure `(A ∩ B) − C = 0` and no forbidden families leak  
6. `node scripts/mujoco_abi/nm_coverage.mjs ... --out dist/<ver>/abi/nm_coverage.json` → record implementation coverage

See `docs/ABI_SCAN.md` for detailed rationale.

## Building locally (canonical flow)

Preferred environment: WSL Ubuntu 22.04 (or Docker) mirroring the GitHub Actions workflow.

1. **Mirror & build (Windows host):**
   ```powershell
   pwsh -NoLogo -NoProfile -ExecutionPolicy Bypass `
     -File local_tools/wsl/run.ps1 -Sync -Clean -Meta -PinNode20 -UseTemp -Jobs 6
   ```
   For incremental builds (already mirrored), drop `-Sync` and `-UseTemp` if not needed.

2. **Generate ABI descriptors (must run before post_build):**
   ```powershell
   pwsh scripts/mujoco_abi/run.ps1 -Repo external/mujoco -Ref 3.2.5 -OutDir dist/3.2.5/abi
   pwsh scripts/mujoco_abi/run.ps1 -Repo external/mujoco -Ref 3.3.7 -OutDir dist/3.3.7/abi
   ```

3. **Run post-build checks inside WSL (after `build.sh`):**
   ```bash
   source /root/emsdk/emsdk_env.sh >/dev/null 2>&1
   ./scripts/ci/post_build.sh --version 3.2.5 --short 325
   ./scripts/ci/post_build.sh --version 3.3.7 --short 337
   ```

Notes:

- Always run builds on WSL ext4 (e.g., `~/dev/mujoco-wasm-forge`) or use `-UseTemp` to build under `/tmp`. Avoid `/mnt/c/...` / OneDrive to prevent I/O issues.
- Starting from a fresh workspace (`-UseTemp` or clean clone) best mirrors CI.
- Default parallelism is 6 (`-Jobs` overrides).
- The sync helper excludes `.git` and cleans stray `?root?...` folders; prefer it over manual copying.

## Using artifacts in other projects

- After building, copy only `dist/<mjVer>/` into the consumer repo.  
- Load `dist/<mjVer>/mujoco.{js,wasm}` directly (avoid copying `build/` or `external/`).  
- 3.3.7 enforces static qhull; artifacts already reflect that configuration.  
- With `-Meta`/`META=1`, metadata files accompany the JS/WASM output.

## Versioning

- Stable tags: `forge-<mujocoVersion>-r<rev>` (e.g., `forge-3.3.7-r2`)  
- Pre-release tags: `forge-<mujocoVersion>-rc.<n>`  
- Artifacts are immutable; fixes publish a new revision (increment `-rN`)

## Notes

- Front-end demo (work in progress): https://github.com/lshdlut/mujoco-wasm-play

## Acknowledgements

This project draws inspiration from earlier MuJoCo-to-WASM experiments that proved the concept and documented key pitfalls:

- [stillonearth/MuJoCo-WASM](https://github.com/stillonearth/MuJoCo-WASM)
- [zalo/mujoco_wasm](https://github.com/zalo/mujoco_wasm)
- [hashb/mujoco_web](https://github.com/hashb/mujoco_web)

While mujoco-wasm-forge has since evolved into an independent toolchain, we remain grateful for their pioneering work.

## Provenance

Portions of this repository’s scripts and documentation were authored or refined with the help of generative AI, then reviewed by a human maintainer.
